<?php
/**
 * @file
 * Tests for the linkback trackback module.
 */

/**
 * Test the receive mechanism for trackbacks.
 */
class LinkbackTrackbackReceiveTestCase extends DrupalWebTestCase {

  public static function getInfo() {
    return array(
      'name' => 'Trackback: receiving trackbacks',
      'description' => 'Test the trackback rdf data is added to nodes which are enabled for receiving linkbacks, and that the receiving mechanism correctly stores trackbacks.',
      'group' => 'Linkback',
    );
  }

  function setUp() {
    parent::setUp('linkback', 'linkback_trackback');

    // Create a content-type; enable it to receive linkbacks.
    $type_machine_name = 'dummy_contenttype1';
    $type = array(
      'type' => $type_machine_name,
      'name' => st('Linkback dummy content-type 1'),
      'base' => 'node_content',
      'description' => st("A dummy content-type, used for testing the Linkback Trackback module. This content-type should not be visible."),
      'custom' => 1,
      'modified' => 1,
      'locked' => 0,
    );
    $type = node_type_set_defaults($type);
    node_type_save($type);
    node_add_body_field($type);

    // Enable linkback-receive for this content-type.
    variable_set("linkback_send_{$type_machine_name}", FALSE);
    variable_set("linkback_receive_{$type_machine_name}", TRUE);
  }


  /**
   * Test that nodes correctly add the trackback RDF metadata when configured
   * to receive linkbacks.
   */
  function testRdfMetadataAddedToNodes() {

    // Create a new node.
    $settings = array(
      'type' => 'dummy_contenttype1',
      'title' => 'Example node used for testing the linkback trackback module.',
      'body' => array(
        LANGUAGE_NONE => array(
          0 => array(
            'value' => "Lorem ipsum dolizzle gizzle tellivizzle, dawg adipiscing sure. Nullizzle sapizzle velizzle, shit volutpat, suscipizzle quizzle, gravida brizzle, pizzle. Pellentesque break it down tortizzle",
            'format' => filter_default_format(),
          ),
        ),
      ),
    );
    $node = $this->drupalCreateNode($settings);

    // Get the node's page. It should have RDF on it.
    $this->drupalGet("node/{$node->nid}");

    // Example trackback RDF:
    // <!--
    // <rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:trackback="http://madskills.com/public/xml/rss/module/trackback/">
    //   <rdf:Description
    //     rdf:about="http://example.com/node/1"
    //     dc:identifier="http://example.com/node/1"
    //     dc:title="Lorem ipsum dolizzle"
    //     trackback:ping="http://example.com/node/1/trackback" />
    // </rdf:RDF>
    // -->
    $url = url("node/{$node->nid}", array('absolute' => TRUE));
    $tb_url = url("node/{$node->nid}/trackback", array('absolute' => TRUE));

    $rdf_text = "\n<!--\n";
    $rdf_text .= '<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:trackback="http://madskills.com/public/xml/rss/module/trackback/">' . "\n";
    $rdf_text .= "\t" . '<rdf:Description';
    $rdf_text .= ' rdf:about="' . $url . '"';
    $rdf_text .= ' dc:identifier="' . $url . '"';
    $rdf_text .= ' dc:title="' . strtr(check_plain($node->title), array('--' => '&mdash;')) . '"';
    $rdf_text .= ' trackback:ping="' . $tb_url . '" />' . "\n";
    $rdf_text .= '</rdf:RDF>';
    $rdf_text .= "\n-->\n";

    $this->assertRaw($rdf_text, t('The RDF metadata is added to the page when linkback is enabled for a node.'));

    // Re-configure the node to disable linkback-receive.
    $node->linkback_receive = FALSE;
    _linkback_node_save($node);

    // Retest for the RDF.
    $this->drupalGet("node/{$node->nid}");
    $this->assertNoRaw($rdf_text, t('The RDF metadata is NOT added to the page when linkback is disabled for a node.'));
  }

  /**
   * Test that the trackback URL (node/%node/trackback) accepts valid trackback
   * requests.
   */
  function testTrackbackEndpointAcceptsValidTrackbacks() {
    // Create a new node.
    $settings = array(
      'type' => 'dummy_contenttype1',
      'title' => 'Example node used for testing the linkback trackback module.',
      'body' => array(
        LANGUAGE_NONE => array(
          0 => array(
            'value' => "Lorem ipsum dolizzle gizzle tellivizzle, dawg adipiscing sure. Nullizzle sapizzle velizzle, shit volutpat, suscipizzle quizzle, gravida brizzle, pizzle. Pellentesque break it down tortizzle",
            'format' => filter_default_format(),
          ),
        ),
      ),
    );
    $node = $this->drupalCreateNode($settings);

    // Submit a trackback request to /node/nnn/trackback.
    // Provide the GET parameters:
    // - url       The URL of the remote page which links to our site.
    // - blog_name The name of the remote site.
    // - title     The subject of the remote blog post which links to ours.
    // - excerpt   Relevant excerpt of the remote blog post.
    $query = array(
      'url'       => 'http://example.com/foshizzle',
      'blog_name' => 'foo',
      'title'     => 'bar',
      'excerpt'   => 'Lorem ipsum dolizzle',
    );
    $this->drupalGet("node/{$node->nid}/trackback", array('query' => $query));


    // There should now be an entry in the db tables:
    // - linkback_trackback_received
    // - node_linkback_received
    $result = db_select('linkback_trackback_received', 'l')
      ->fields('l')
      ->condition('l.nid', $node->nid)
      ->condition('l.url', 'http://example.com/foshizzle')
      ->execute()
      ->fetchAll();
    $this->assertEqual(1, count($result), t('A trackback record has been saved to the linkback_trackback_received table.'));


    $result = db_select('node_linkback_received', 'l')
      ->fields('l')
      ->condition('l.nid', $node->nid)
      ->condition('l.url', 'http://example.com/foshizzle')
      ->execute()
      ->fetchAll();
    $this->assertEqual(1, count($result), t('A linkback record has been saved to the node_linkback_received table.'));

  }


  /**
   * @TODO:
   * Test that the trackback URL (node/%node/trackback) rejects invalid
   * trackback requests.
   */
  // function testTrackbackEndpointRejectsInvalidTrackbacks() {
  //
  // }

}



/**
 * Test the Send mechanism for trackbacks.
 */
class LinkbackTrackbackSendTestCase extends DrupalWebTestCase {

  public static function getInfo() {
    return array(
      'name' => 'Trackback: send trackbacks',
      'description' => 'Test that trackbacks are sent when a node is saved.',
      'group' => 'Linkback',
    );
  }

  function setUp() {
    parent::setUp('linkback', 'linkback_trackback');

    // Create a content-type; enable it to send linkbacks.
    $type_machine_name = 'dummy_contenttype1';
    $type = array(
      'type' => $type_machine_name,
      'name' => st('Linkback dummy content-type 1'),
      'base' => 'node_content',
      'description' => st("A dummy content-type, used for testing the Linkback Trackback module. This content-type should not be visible."),
      'custom' => 1,
      'modified' => 1,
      'locked' => 0,
    );
    $type = node_type_set_defaults($type);
    node_type_save($type);
    node_add_body_field($type);

    // Enable linkback-receive for this content-type.
    variable_set("linkback_send_{$type_machine_name}", TRUE);
  }


  /**
   * Test the auto-detection of Trackback endpoints.
   */
  function testTrackbackEndpointAutodetection() {
    // The helper module provides a set of local end-points which provide a
    // variety of Trackback meta-data formats.
    module_enable(array('linkback_trackback_dummy_endpoints'));

    // Array of local path => discoverable endpoint.
    $target_urls = array(
      'trackback_dummy_endpoint/1' => NULL,
      'trackback_dummy_endpoint/2' => FALSE,
      'trackback_dummy_endpoint/3' => FALSE,
      'trackback_dummy_endpoint/4' => 'http://www.foo.com/tb.cgi/5',
      'trackback_dummy_endpoint/5' => 'http://example.com/tb/5',
      'trackback_dummy_endpoint/6' => 'http://example.com/tb/6',
      'trackback_dummy_endpoint/7' => 'http://example.com/tb/7b',
      'trackback_dummy_endpoint/8' => FALSE,
    );

    foreach ($target_urls as $local_url => $expected_endpoint) {
      $url = url($local_url, array('absolute' => TRUE));
      $result = linkback_trackback_autodetect_trackback_support($url);
      $this->assertEqual($result, $expected_endpoint, t('Endpoint correctly discovered for @url', array('@url' => $url)));
    }
  }
}
